# Project Context: Absence Data Aggregation Tool

## Quick Summary
This project aggregates monthly absence/attendance records from 12 Excel files (01-12.2568.xlsx) into a comprehensive yearly report with 5 sheets:
1. **Executive Summary** - CEO view (30 seconds)
2. **Suspicious** - 39 flagged employees for HR review
3. **Merged Names** - 21 merged employees with audit trail (shows original names + monthly ID progression)
4. **Summary** - Data validation (proves correctness)
5. **Employees** - Complete detailed data (240 rows)

## To Run
```bash
python3 aggregate_absence.py
```

This processes 7 available months (01-07.2568.xlsx) and outputs `absence-summary-2568.xlsx`

## Important Context

### Data Merging (1,214 → 240 employees)
The script detects duplicate employee records across months using **fuzzy name matching**:
- Matches: prefix (นาย/นาง/นางสาว) + firstname + lastname
- Ignores: nicknames and middle names
- Allows: 80% lastname similarity (catches typos)
- Result: 974 records merged, 240 unique employees

### The 17 Absence Types
All tracked: Work Days, Absent, Personal Leave, Sick (w/cert), Sick (no cert), Maternity, Late (grace), Late (penalty), OT Leave, Suspension, Annual Leave, OT 2.5hr, OT >2.5hr, Holiday Work, Holiday OT, Night Shift, Multi-Machine Control

### Key Features
- **Auto-detects problems**: 39 employees flagged for:
  - Multiple IDs (job changes)
  - Quit records (ลาออก)
  - Transfers (ย้ายมา)
  - Restarts (เริ่มใหม่)
  - Incomplete merges (/)
- **Validates calculations**: Raw vs summary totals comparison
- **CEO-friendly**: Executive Summary shows big picture in 30 seconds
- **Readable output**: Large fonts, colors, auto-fit columns

## Recent Changes

### Dec 16, 2025 Latest
✅ Added **Merged Names** sheet - shows all 21 merged employees with:
  - Original names (all name variations that were combined)
  - Merge type (ID Change / Fuzzy 80% / Name Variation)
  - Monthly ID columns (Jan-Jul showing which ID appeared each month)
✅ Added merge reason tracking in aggregation (tracks why each merge happened)
✅ Added **Executive Summary** sheet as first sheet (CEO view)
✅ Removed **Checklist** sheet (too cluttered)
✅ Improved **Suspicious** sheet formatting (bold red flags, no pink background)
✅ Created comprehensive README.md documentation

### Earlier Improvements
- Fuzzy name matching for typos (80% threshold)
- Suspicious record detection (39 problematic cases)
- Validation sheet with raw vs summary totals
- Thai language support for all headers
- Auto-column width adjustment
- Bold red highlighting for flags

## File Structure
```
/Users/polamin/Documents/ssp-adhoc-absensesSummary/
├── aggregate_absence.py          # Main script (~750 lines)
├── README.md                      # Complete documentation
├── .claude.md                     # This file
├── absence-summary-2568.xlsx      # Output (regenerated each run)
├── 01.2568.xlsx through 07.2568.xlsx  # Input monthly files
└── (01-12.2568.xlsx for full year)
```

## Configuration

### To Adjust Matching Threshold
Find `find_fuzzy_match()` function and change `threshold` parameter:
```python
fuzzy_key = find_fuzzy_match(..., threshold=0.80)  # Current: 80%
# Increase to 0.85 to be more strict (fewer merges)
# Decrease to 0.75 to be more loose (more merges)
```

### To Add More Months
Just place files 08.2568.xlsx - 12.2568.xlsx in the same directory and run script. It automatically finds and processes all XX.2568.xlsx files.

### To Change Output Filename
Modify last parameter in `main()`:
```python
export_to_excel(df_output, summary_df, aggregated, all_months_data, 'custom-name.xlsx')
```

## Common Questions

**Q: Why do raw totals differ from summary totals?**
A: Not an error. When employees merge, their 7 monthly records become 1 summary row. The math is preserved (tested in Summary sheet), but the count goes down. This is expected.

**Q: Why are some employees in Suspicious sheet?**
A: They have data quality issues requiring HR review:
- Multiple IDs = job change (verify months counted)
- Quit records = partial year (expected)
- Transfers = came from old system (ID may need verification)
- Restarts = came back after break (partial year)
- "/" in name = incomplete merge (verify it's one person)

**Q: How do I verify the calculations?**
A: Go to Summary sheet and check the "Match?" column. All should show ✓ (confirmed no data loss during merging).

**Q: Can I use this for different file formats?**
A: Not without modification. Script assumes:
- Filename pattern: XX.2568.xlsx
- Structure: 42 columns (ID, Name, Notes, Pos, Dept, PayType + 17 absence types × 2 halves)
- Header rows: 3 rows to skip
- Modify `load_monthly_file()` and `extract_absence_data()` for other formats

## Script Architecture

**Phase 1: Load** → `find_monthly_files()` + `load_monthly_file()`
↓
**Phase 2: Extract** → `extract_absence_data()` (per file)
↓
**Phase 3: Aggregate** → `aggregate_yearly_totals()` (fuzzy matching)
↓
**Phase 4: Create Sheets** →
- `create_executive_summary()` - CEO view
- `create_suspicious_sheet()` - Problem records
- `create_merged_names_sheet()` - Merge audit trail
- `calculate_summary_stats()` - Validation
- `create_output_dataframe()` - Employees
↓
**Phase 5: Export** → `export_to_excel()` (formatting + write)

## Known Limitations

1. **Name matching**: 80% threshold may miss some duplicates or create false matches
2. **Thai names**: Better handled than English, but some variations may not merge
3. **Department changes**: If employee changes dept mid-year, may show 2 departments
4. **Multiple IDs**: If employee has 2+ IDs across months, all are stored (not just latest)

## Testing Notes

- Processed 7 months: Jan-Jul 2568
- Result: 240 unique employees (from 1,214 records)
- Suspicious count: 39 employees (16% needing review)
- Validation: All 17 absence type totals match raw vs summary

---

**For future work**: Keep README.md and this file in sync with any major changes. The main logic is in `create_executive_summary()` and `create_suspicious_sheet()` - most changes affect these two functions.
